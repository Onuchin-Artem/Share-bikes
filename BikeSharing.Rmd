---
title: "Bike sharing"
output: pdf_document
---
Load default libraries
----------------------
```{r, message=F, warning=F}
library(data.table)
library(dplyr)
library(lubridate)
library(ggplot2)
library(caret)
library(stringi)
library(xgboost)
theme_set(theme_bw())
set.seed(42)
```
Read the data
-------------
```{r, message=F, warning=F}
full_train = fread("./train.csv", header = T, sep = ",", integer64 = "numeric")
test = fread("./test.csv", header = T, sep = ",", integer64 = "numeric")
```

Change type to categorical variables
------------------------------------
```{r}
fix_types = function(data) {
  data %>% 
    mutate(
      datetime = ymd_hms(datetime),
      workingday = as.character(workingday),
      weather = as.character(weather)) %>%
    mutate(
      year = as.character(year(datetime)),
      month = as.character(month(datetime)),
      day = as.character(mday(datetime)),
      wday = as.character(wday(datetime)),
      hour = as.character(hour(datetime)))
  
}
full_train = fix_types(full_train)
test = fix_types(test)

train = full_train[as.integer(full_train$day) < 13]
validate = full_train[as.integer(full_train$day) >= 13]

```

Prepare features
----------------
```{r, echo=FALSE}

dummy = dummyVars(~ workingday + weather + month + wday + hour + year,
                  data = train,
                  fullRank = T,
                  levelsOnly = T)

summarise_stats = function(groups) {
  groups %>% summarise(
    avg_count = mean(count),
    casual_ratio1 = sum(casual) / sum(count),
    casual_ratio2 = mean(casual / count))
}

stats_names = c('avg_count', 'count5', 'count95', 'avg_casual', 'casual5', 'casual95', 'avg_registered', 
                'registered5', 'registered95', 'casual_ratio1', 'casual_ratio2')

train_hour_statistics = train %>% group_by(hour) %>% summarise_stats()
full_train_hour_statistics = full_train %>% group_by(hour) %>% summarise_stats()
train_wday_statistics = train %>% group_by(wday) %>% summarise_stats()
full_train_wday_statistics = full_train %>% group_by(wday) %>% summarise_stats()
train_month_statistics = train %>% group_by(month) %>% summarise_stats()
full_train_month_statistics = full_train %>% group_by(month) %>% summarise_stats()


names = names(predict(dummy, train) %>% as.data.frame())
prepare_dataset_features = function(data, hour_statistics, wday_statistics, month_statistics) {
  categorical_data = predict(dummy, data) %>% as.data.frame()
  Missing = setdiff(names, names(categorical_data))  # Find names of missing columns
  categorical_data[Missing] = 0                    # Add them, filled with '0's
  categorical_data = categorical_data[names]
  numeric_data = data %>% select(c(temp, atemp, humidity, windspeed))
  hour_stats_data = inner_join(data, hour_statistics, by="hour") %>%
    select(avg_count:casual_ratio2)
  wday_stats_data = inner_join(data, wday_statistics, by="wday") %>%
    select(avg_count:casual_ratio2)
  month_stats_data = inner_join(data, month_statistics, by="month") %>%
    select(avg_count:casual_ratio2)

  prepared_data = cbind(
    categorical_data,
    numeric_data,
    hour_stats_data,
    wday_stats_data,
    month_stats_data)
  as.matrix(prepared_data)
}

train_matrix = prepare_dataset_features(train, 
                                        train_hour_statistics, 
                                        train_wday_statistics, 
                                        train_month_statistics)
validate_matrix = prepare_dataset_features(validate, 
                                           train_hour_statistics, 
                                           train_wday_statistics, 
                                           train_month_statistics)

test_matrix = prepare_dataset_features(test,
                                       full_train_hour_statistics, 
                                       full_train_wday_statistics, 
                                       full_train_month_statistics)
full_train_matrix = prepare_dataset_features(full_train,
                                             full_train_hour_statistics, 
                                             full_train_wday_statistics,
                                             full_train_month_statistics)
```

Prepare target
--------------
We going to predict log(Y+1) to optimize the target cost function
```{r}
preparedTrainTarget = log(train$count + 1)
preparedValidateTarget = log(validate$count + 1)
preparedFullTarget =log(full_train$count + 1)

```

Xgboost train and cross-validate
--------------------------------
Interesting link: [how to tune hyperparameters](http://www.slideshare.net/odsc/owen-zhangopen-sourcetoolsanddscompetitions1)
```{r}
dtrain <- xgb.DMatrix(train_matrix, label = preparedTrainTarget)

xgbControl = list(
   subsample=0.5, colsample_bytree = 0.7, metrics=list("rmse"), min_child_weight = 30,
                  max.depth = 6, eta = 0.1, alpha = 2, lambda = 20, objective = "reg:linear"
)
model = xgboost(params = xgbControl, data = dtrain, 
                nround=200, nthread = 2, print.every.n = 33)
history <- xgb.cv(params = xgbControl, data = dtrain, 
                  nround=200, nthread = 2, nfold = 5, print.every.n = 33)
print(tail(history))

```
Validate Score
------------------------
```{r}
validate_predictions = predict(model, validate_matrix)
RMSE(validate_predictions, preparedValidateTarget)

```

Feature importance
------------------
```{r}
imp = xgb.importance(colnames(train_matrix), model = model)
xgb.plot.importance(imp)

```
Train on full dataset
------------------------
```{r}
dtrain_final <- xgb.DMatrix(full_train_matrix, label = preparedFullTarget)

model_final = xgboost(params = xgbControl, data = dtrain_final, 
                      nround=200, nthread = 2, print.every.n = 33)

history <- xgb.cv(params = xgbControl, data = dtrain_final, 
                  nround=200, nthread = 2, print.every.n = 33, nfold = 5)

```


Predict and un-log predictions
------------------------------

```{r}
predictions = predict(model_final, test_matrix)
fixed_predictions = exp(predictions) - 1
```

Write the result
----------------
```{r}
result = cbind(as.character(test$datetime), fixed_predictions) %>% as.data.frame()
names(result) = c('datetime', 'count')
write.csv(result, 'submission.csv', quote = F, row.names = F)
```